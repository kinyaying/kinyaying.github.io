---
title: è§£æ Vue3.0 çš„ dom-diff æ ¸å¿ƒç®—æ³•â€”â€”æœ€é•¿é€’å¢å­åºåˆ—
date: 2021-02-09 13:58:06
tags: ç®—æ³•
keywords:
  - vue3 dom-diff æ ¸å¿ƒç®—æ³•
  - dom-diff
  - æœ€é•¿é€’å¢å­åºåˆ—
---

# ä¸€ã€åŸºç¡€èƒŒæ™¯

å»å¹´ Vue3.0 æ­£å¼ç‰ˆæœ¬æ¨å‡ºï¼Œå—åˆ°å¾ˆå¤šäººçš„è¿½æ§ã€‚vue3.0 ä¸­ä¹Ÿå¯¹ dom-diff ç®—æ³•è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå…¶ä¸­å°±ç”¨åˆ°äº† **ã€Œæœ€é•¿é€’å¢å­åºåˆ—ã€**ã€‚

å…ˆç®€è¦ä»‹ç»ä¸‹åŸºç¡€èƒŒæ™¯ã€‚æˆ‘ä»¬åœ¨ vue å¼€å‘é¡¹ç›®çš„æ—¶å€™ï¼Œå¸¸ç”¨æ¨¡æ¿æˆ–è€… jsx è¯­æ³•æ¥ç¼–å†™ DOMã€‚å®é™…ä¸Šæˆ‘ä»¬ç¼–å†™çš„ä»£ç ä¼šè¢«`@vue/compiler-dom`è½¬åŒ–ä¸ºè™šæ‹Ÿ DOM èŠ‚ç‚¹ï¼Œå³ Virtual DOMï¼Œä¹‹åå†å°†è™šæ‹Ÿ DOM èŠ‚ç‚¹æ¸²æŸ“æˆå®é™…çš„ DOM èŠ‚ç‚¹ï¼ŒVirtual DOM ä¹Ÿä¼šè¢«ç»„ç»‡æˆæ ‘å½¢ç»“æ„ï¼Œå³ Virtual DOM æ ‘ã€‚ç±»ä¼¼å¦‚ä¸‹æ‰€ç¤º ğŸ‘‡ğŸ½ï¼š
![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/78240500087d4536b74286e30aff5b4c~tplv-k3u1fbpfcp-watermark.image)

<!-- more -->

ä¹Ÿè®¸ä½ ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆè¦å¼•å…¥è™šæ‹Ÿ DOMï¼Œè€Œä¸æ˜¯ç›´æ¥æŠŠç»„ä»¶è½¬æ¢æˆæ­£å¼ DOM èŠ‚ç‚¹å‘¢ï¼Ÿåœ¨æˆ‘çœ‹æ¥æœ‰ä¸¤ä¸ªä¼˜ç‚¹ï¼š

1. **æ›´é«˜æ•ˆï¼š** å½“ç»„ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåˆ©ç”¨è™šæ‹Ÿ DOM æ ‘å¯ä»¥å¯¹æ–°æ—§ DOM è¿›è¡Œæ¯”è¾ƒï¼Œæ‰¾å‡ºåŒºåˆ«ï¼Œåªæ›´æ–°å‘ç”Ÿå˜åŒ–çš„ DOMï¼Œè®©æ¸²æŸ“æ›´åŠ é«˜æ•ˆã€‚
2. **æ›´çµæ´»ï¼š** å°†åŸæ¥ç›´æ¥æ¸²æŸ“å˜æˆå…ˆæ„å»ºè™šæ‹Ÿ DOMï¼Œå†è¿›è¡Œæ¸²æŸ“ã€‚ç›¸å½“äºæŠ½ç¦»å‡ºä¸­é—´å±‚ï¼Œå¯¹åº”çš„æ¸²æŸ“å±‚å¯ä»¥æ˜¯é’ˆå¯¹æµè§ˆå™¨çš„æ¸²æŸ“ï¼Œä¹Ÿå¯ä»¥æ˜¯é’ˆå¯¹å°ç¨‹åºç­‰å…¶ä»–å¹³å°çš„æ¸²æŸ“ã€‚

æ ¹æ®ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ Vue ä¼šæŠŠæˆ‘ä»¬ç¼–å†™çš„ç»„ä»¶è½¬æ¢æˆè™šæ‹Ÿ DOM æ ‘ï¼Œå¹¶ä¸”å°†è™šæ‹Ÿ DOM æ ‘è¿›è¡Œæ¯”è¾ƒåå†æ ¹æ®å˜åŒ–æƒ…å†µæ›´æ–°çœŸå® DOMã€‚æ¯”å¦‚åŸæœ‰åˆ—è¡¨ä¸º `[a, b, c, d, e, f]` ï¼Œè€Œæ–°åˆ—è¡¨ä¸º `[a, d, b, c, e, f]`ï¼Œ è¿™æ—¶ä¼šè¿™æ ·è¿›è¡Œ diffï¼š

1. **å»é™¤ç›¸åŒå‰ç½®å’Œåç½®å…ƒç´ ** ï¼Œæ­¤ä¼˜åŒ–ç”± [Neil Fraser](https://neil.fraser.name/writing/diff/) æå‡ºï¼Œå¯ä»¥æ¯”è¾ƒå®¹æ˜“å®ç°è€Œä¸”å¸¦æ¥å¸¦æ¥æ¯”è¾ƒæ˜æ˜¾çš„æå‡ï¼›

   æ¯”å¦‚é’ˆå¯¹ä¸Šæƒ…å†µï¼Œå»é™¤ç›¸åŒçš„å‰ç½®å’Œåç½®å…ƒç´ åï¼ŒçœŸæ­£éœ€è¦å¤„ç†çš„æ˜¯ `[ b, c, d]` å’Œ `[d, b, c]` ï¼Œå¤æ‚æ€§ä¼šå¤§å¤§é™ä½ã€‚

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/64b6fce49042461b9c75213ed74f1dd5~tplv-k3u1fbpfcp-watermark.image)

2. **æœ€é•¿é€’å¢å­åºåˆ—**

   æ¥ç€è¦å°†åŸæ•°ç»„ä¸­çš„`[ b, c, d]` è½¬åŒ–æˆ `[d, b, c]` ã€‚Vue3 ä¸­å¯¹ç§»åŠ¨æ¬¡æ•°è¿›è¡Œäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–ã€‚ä¸‹é¢å¯¹è¿™ä¸ªç®—æ³•è¿›è¡Œä»‹ç»ï¼š

   1. é¦–å…ˆéå†æ–°åˆ—è¡¨ï¼Œé€šè¿‡ key å»æŸ¥æ‰¾åœ¨åŸæœ‰åˆ—è¡¨ä¸­çš„ä½ç½®ï¼Œä»è€Œå¾—åˆ°æ–°åˆ—è¡¨åœ¨åŸæœ‰åˆ—è¡¨ä¸­ä½ç½®æ‰€æ„æˆçš„æ•°ç»„ã€‚æ¯”å¦‚åŸæ•°ç»„ä¸­çš„`[ b, c, d]`ï¼Œ æ–°æ•°ç»„ä¸º `[d, b, c]` ï¼Œå¾—åˆ°çš„ä½ç½®æ•°ç»„ä¸º `[3, 1, 2]` ï¼Œç°åœ¨çš„ç®—æ³•å°±æ˜¯é€šè¿‡ä½ç½®æ•°ç»„åˆ¤æ–­æœ€å°åŒ–ç§»åŠ¨æ¬¡æ•°ï¼›

   2. è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—

      æœ€é•¿é€’å¢å­åºåˆ—æ˜¯ç»å…¸çš„åŠ¨æ€è§„åˆ’ç®—æ³•ï¼Œä¸äº†è§£çš„å¯ä»¥å‰å¾€ [æœ€é•¿é€’å¢å­åºåˆ—](https://baike.baidu.com/item/æœ€é•¿é€’å¢å­åºåˆ—/22828111#1) å»è¡¥å……ä¸€ä¸‹å‰åºçŸ¥è¯†ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæœ€é•¿é€’å¢å­åºåˆ—å°±å¯ä»¥ä¿è¯ç§»åŠ¨æ¬¡æ•°æœ€å°‘å‘¢ï¼Ÿå› ä¸ºåœ¨ä½ç½®æ•°ç»„ä¸­é€’å¢å°±èƒ½ä¿è¯åœ¨æ—§æ•°ç»„ä¸­çš„ç›¸å¯¹ä½ç½®çš„æœ‰åºæ€§ï¼Œä»è€Œä¸éœ€è¦ç§»åŠ¨ï¼Œå› æ­¤é€’å¢å­åºåˆ—çš„æœ€é•¿å¯ä»¥ä¿è¯ç§»åŠ¨æ¬¡æ•°çš„æœ€å°‘

      å¯¹äºå‰é¢çš„å¾—åˆ°çš„ä½ç½®æ•°ç»„`[3, 1, 2]`ï¼Œå¾—åˆ°æœ€é•¿é€’å¢å­åºåˆ— `[1, 2]` ï¼Œåœ¨å­åºåˆ—å†…çš„å…ƒç´ ä¸ç§»åŠ¨ï¼Œä¸åœ¨æ­¤å­åºåˆ—çš„å…ƒç´ ç§»åŠ¨å³å¯ã€‚å¯¹åº”çš„å®é™…çš„èŠ‚ç‚¹å³ `d` èŠ‚ç‚¹ç§»åŠ¨è‡³`b, c`å‰é¢å³å¯ã€‚

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef1b8d1d19d1489fb0c50dbbed2dabfb~tplv-k3u1fbpfcp-watermark.image)

æœ¬æ–‡å°±å°†ä»‹ç»æœ€é•¿é€’å¢å­åºåˆ—çš„ç®—æ³•ã€‚å¤§å®¶å¯ä»¥é…åˆç€ Vue3 ä¸­çš„æºç æ¥é˜…è¯»ï¼Œå¸Œæœ›è¯»å®Œè¿™ç¯‡æ–‡ç« åèƒ½å¤Ÿæ›´åŠ ç†è§£ Vue3 ä¸­å…³äºæœ€é•¿é€’å¢å­åºåˆ—çš„å®ç°ã€‚

Vue3.0 çš„æºç  ğŸ‘‰ï¼š[vue-next/renderer.ts](https://github.com/vuejs/vue-next/blob/540e26f49c09edf09b6a60ac2a978fdec52686bf/packages/runtime-core/src/renderer.ts) è¯·é˜…è¯»å…¶ä¸­çš„`getSequence`æ–¹æ³•ã€‚

åŠ›æ‰£ä¸Šæ²¡æœ‰å®Œå…¨ä¸€æ ·çš„é¢˜ç›®ï¼Œæœ‰ä¸€é“æœ€æ¥è¿‘çš„é¢˜ [300. æœ€é•¿é€’å¢å­åºåˆ—](https://leetcode-cn.com/problems/longest-increasing-subsequence/) ï¼Œå®ƒçš„è¦æ±‚æ˜¯æ±‚æœ€é•¿é€’å¢å­åºåˆ—çš„é•¿åº¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠé¢˜ç›®æ¢æˆæ±‚æœ€é•¿é€’å¢å­åºåˆ—çš„ç´¢å¼•ã€‚

# äºŒã€é¢˜ç›®æè¿°ï¼š

ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ `nums` ï¼Œæ‰¾åˆ°å…¶ä¸­æœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—çš„é•¿åº¦ã€‚

å­åºåˆ—æ˜¯ç”±æ•°ç»„æ´¾ç”Ÿè€Œæ¥çš„åºåˆ—ï¼Œåˆ é™¤ï¼ˆæˆ–ä¸åˆ é™¤ï¼‰æ•°ç»„ä¸­çš„å…ƒç´ è€Œä¸æ”¹å˜å…¶ä½™å…ƒç´ çš„é¡ºåºã€‚ä¾‹å¦‚ï¼Œ[3,6,2,7] æ˜¯æ•°ç»„ [0,3,1,6,2,2,7] çš„å­åºåˆ—ã€‚

**ç¤ºä¾‹ 1ï¼š**

> è¾“å…¥ï¼šnums = [10,9,2,5,3,7,101,18]
> è¾“å‡ºï¼š[ 2, 4, 5, 7 ]
> è§£é‡Šï¼šæœ€é•¿é€’å¢å­åºåˆ—æ˜¯ [2,3,7,18]ï¼Œå› æ­¤ç´¢å¼•æ˜¯[ 2, 4, 5, 7 ]ã€‚

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d8fe1a74e0934fc1b8a83d2416ce866d~tplv-k3u1fbpfcp-watermark.image)

è¿™é‡Œå†å¼ºè°ƒä¸€éï¼Œæˆ‘ä»¬è¦æ±‚çš„æ˜¯æœ€é•¿å­åºåˆ—å¯¹åº”çš„ç´¢å¼•ã€‚

**ç¤ºä¾‹ 2ï¼š**

> è¾“å…¥ï¼šnums = [0,1,0,3,2,3]
> è¾“å‡ºï¼š[ 0, 1, 4, 5 ]
>
> è§£é‡Šï¼šæœ€é•¿é€’å¢å­åºåˆ—æ˜¯ [0,1,2,3]ï¼Œå› æ­¤ç´¢å¼•æ˜¯[ 0,1,4,5 ]ã€‚

**ç¤ºä¾‹ 3ï¼š**

> è¾“å…¥ï¼šnums = [7,7,7,7,7,7,7]
> è¾“å‡ºï¼š[0]
>
> è§£é‡Šï¼šæœ€é•¿é€’å¢å­åºåˆ—æ˜¯ [7]ï¼Œå› æ­¤ç´¢å¼•æ˜¯[0]ã€‚

æ•²é»‘æ¿ï¼ŒğŸ‘©â€ğŸ«ï¼Œæˆ‘ä»¬è¦æ±‚çš„æ˜¯æœ€é•¿é€’å¢å­åºåˆ—çš„ç´¢å¼•ã€‚okï¼Œå¼ºè°ƒå®Œäº†ï¼Œå¼€å§‹è§£é¢˜å§ã€‚

# ä¸‰ã€æ€è·¯åˆ†æï¼š

å‡è®¾æˆ‘ä»¬è¦å®ç° getSequence æ–¹æ³•ï¼Œå…¥å‚æ˜¯ nums æ•°ç»„ï¼Œè¿”å›ç»“æœæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚

```js
/**
 * @param {number[]} nums
 * @return {number[]}
 */
var getSequence = function (nums) {
  // your code
}
```

æ­¥éª¤ 1. å…ˆåˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ result ä¿å­˜ç´¢å¼•ã€‚éå† numsï¼Œå°†å½“å‰é¡¹`current`å’Œ result çš„æœ€åä¸€é¡¹å¯¹åº”çš„å€¼`last`è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå½“å‰é¡¹å¤§äºæœ€åä¸€é¡¹ï¼Œç›´æ¥å¾€ result ä¸­æ–°å¢ä¸€é¡¹ï¼›å¦åˆ™ï¼Œé’ˆå¯¹ result æ•°ç»„è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¹¶æ›¿æ¢æ¯”å½“å‰é¡¹å¤§çš„é‚£é¡¹ã€‚ä¸‹å›¾ç¤ºæ„å›¾ä¸­ä¸ºäº†æ–¹ä¾¿ç†è§£ result å­˜æ”¾çš„æ˜¯ nums ä¸­çš„å€¼ï¼Œå®é™…ä»£ç å­˜æ”¾çš„æ˜¯æ•°ç»„ç´¢å¼•ã€‚
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/daa7150e1a3040ad8359112ae01fa23f~tplv-k3u1fbpfcp-watermark.image)
æ­¥éª¤ 2. è¿™æ­¥æ˜¯éš¾ç‚¹ï¼Œå› ä¸ºæ­¥éª¤ 1 åœ¨æ›¿æ¢çš„è¿‡ç¨‹ä¸­`è´ªå¿ƒ`äº†ï¼Œå¯¼è‡´æœ€åçš„ç»“æœé”™ä¹±ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨çš„`å‰é©±èŠ‚ç‚¹`çš„æ¦‚å¿µï¼Œéœ€è¦å†åˆ›å»ºä¸€ä¸ªæ•°ç»„ preIndexArrã€‚åœ¨æ­¥éª¤ 1 å¾€ result ä¸­æ–°å¢æˆ–è€…æ›¿æ¢æ–°å€¼çš„æ—¶å€™ï¼ŒåŒæ—¶ preIndexArr æ–°å¢ä¸€é¡¹ï¼Œè¯¥é¡¹ä¸ºå½“å‰é¡¹å¯¹åº”çš„å‰ä¸€é¡¹çš„ç´¢å¼•ã€‚è¿™æ ·æˆ‘ä»¬æœ‰äº†ä¸¤ä¸ªæ•°ç»„ï¼š

- resultï¼š[1,3,4,6,7,9]

- preIndexArrï¼š[undefined,0,undefined,1,3,4,4,6,1]

result çš„ç»“æœæ˜¯ä¸å‡†ç¡®çš„ï¼Œä½†æ˜¯ result çš„æœ€åä¸€é¡¹æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæœ€åä¸€é¡¹æ˜¯æœ€å¤§çš„ï¼Œæœ€å¤§çš„ä¸ä¼šç®—é”™ã€‚æˆ‘ä»¬å¯çŸ¥æœ€å¤§ä¸€é¡¹æ˜¯å€¼ 9ï¼Œç´¢å¼•æ˜¯ 7ã€‚å¯æŸ¥è¯¢`preIndexArr[7]`è·å¾— 9 çš„å‰ä¸€é¡¹çš„ç´¢å¼•ä¸º 6ï¼Œå€¼ä¸º 7...ä¾æ¬¡ç±»æ¨èƒ½å¤Ÿé‡å»ºæ–°çš„ resultã€‚

æ³¨æ„ï¼šä¸‹å›¾ä¸­ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œresult å­˜æ”¾çš„æ˜¯å€¼ï¼Œå®é™…ä»£ç ä¸­å­˜æ”¾çš„æ˜¯ç´¢å¼•ã€‚
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/784259c30746464c98481a9270350fa6~tplv-k3u1fbpfcp-watermark.image)
okï¼Œæ€è·¯è¯´å®Œäº†ï¼Œé‚£ä¹ˆä¸‹é¢å°±å¼€å§‹ç ä»£ç äº† ğŸ§‘â€ğŸ’»

## æ­¥éª¤ 1

```js
var getSequence1 = function (nums) {
  let result = []
  for (let i = 0; i < nums.length; i++) {
    let last = nums[result[result.length - 1]],
      current = nums[i]
    if (current > last || last === undefined) {
      // å½“å‰é¡¹å¤§äºæœ€åä¸€é¡¹
      result.push(i)
    } else {
      // å½“å‰é¡¹å°äºæœ€åä¸€é¡¹ï¼ŒäºŒåˆ†æŸ¥æ‰¾+æ›¿æ¢
      let start = 0,
        end = result.length - 1,
        middle
      while (start < end) {
        middle = Math.floor((start + end) / 2)
        if (nums[result[middle]] > current) {
          end = middle
        } else {
          start = middle + 1
        }
      }
      result[start] = i
    }
  }
  return result
}
```

## æ­¥éª¤ 2

```js
var getSequence = function (nums) {
  let result = [],
    preIndex = []
  for (let i = 0; i < nums.length; i++) {
    let last = nums[result[result.length - 1]],
      current = nums[i]
    if (current > last || last === undefined) {
      // å½“å‰é¡¹å¤§äºæœ€åä¸€é¡¹
      preIndex[i] = result[result.length - 1]
      result.push(i)
    } else {
      // å½“å‰é¡¹å°äºæœ€åä¸€é¡¹ï¼ŒäºŒåˆ†æŸ¥æ‰¾+æ›¿æ¢
      let start = 0,
        end = result.length - 1,
        middle
      while (start < end) {
        // é‡åˆå°±è¯´æ˜æ‰¾åˆ°äº† å¯¹åº”çš„å€¼,æ—¶é—´å¤æ‚åº¦O(logn)
        middle = Math.floor((start + end) / 2) // æ‰¾åˆ°ä¸­é—´ä½ç½®çš„å‰ä¸€ä¸ª
        if (nums[result[middle]] > current) {
          end = middle
        } else {
          start = middle + 1
        }
      }

      // å¦‚æœç›¸åŒ æˆ–è€… æ¯”å½“å‰çš„è¿˜å¤§å°±ä¸æ¢äº†
      if (current < nums[result[start]]) {
        preIndex[i] = result[start - 1] // è¦å°†ä»–æ›¿æ¢çš„å‰ä¸€ä¸ªè®°ä½
        result[start] = i
      }
    }
  }
  // åˆ©ç”¨å‰é©±èŠ‚ç‚¹é‡æ–°è®¡ç®—result
  let length = result.length, //æ€»é•¿åº¦
    prev = result[length - 1] // æœ€åä¸€é¡¹
  while (length-- > 0) {
    // æ ¹æ®å‰é©±èŠ‚ç‚¹ä¸€ä¸ªä¸ªå‘å‰æŸ¥æ‰¾
    result[length] = prev
    prev = preIndex[result[length]]
  }
  return result
}
```

**å°ç»“ï¼š**

- æœ¬é¢˜ç›®ç”¨åˆ°çš„æ ¸å¿ƒæ€æƒ³æœ‰ï¼šè´ªå¿ƒï¼ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œå‰é©±èŠ‚ç‚¹

- è¿™ä¸ªé¢˜è§£çš„æ—¶é—´å¤æ‚åº¦ä¸º`O(nlogn)`ï¼Œå³ for å¾ªç¯çš„`n`ä¹˜ä»¥äºŒåˆ†æŸ¥æ‰¾çš„`logn`

# å››ã€å®Œæ•´ä»£ç ï¼š

åœ¨ **ä¸‰ã€æ€è·¯åˆ†æ**çš„æ­¥éª¤ 2 å·²ç»™å‡ºå®Œæ•´ä»£ç 

# äº”ã€æ€»ç»“ï¼š

æœ¬æ–‡ä»‹ç»äº†[300. æœ€é•¿é€’å¢å­åºåˆ—](https://leetcode-cn.com/problems/longest-increasing-subsequence/)çš„å…¶ä¸­ä¸€ç§è§£é¢˜æ€è·¯ï¼Œæ ¸å¿ƒæ€æƒ³ç”¨åˆ°äº†**è´ªå¿ƒï¼ŒäºŒåˆ†æŸ¥æ‰¾å’Œå‰é©±èŠ‚ç‚¹**ã€‚

vue3.0 ä¸­æ ¸å¿ƒ dom-diff ç®—æ³•ç”¨åˆ°äº†æœ€é•¿é€’å¢å­åºåˆ—ï¼Œå­¦ä¹ æŒæ¡æ­¤é¢˜çš„è§£æ³•æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½çš„äº†è§£ vue3.0 çš„ dom-diffã€‚

æ„Ÿè°¢é˜…è¯»~
